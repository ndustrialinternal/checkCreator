<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Check Creator</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      margin: 1rem; 
      max-width: 800px; 
      margin: 2rem auto; 
      padding-left: 270px; /* Account for sidebar */
    }
           /* Navigation Sidebar */
        .sidebar {
      width: 250px;
      background: linear-gradient(135deg, #8DB843 0%, #6B9532 100%);
      color: white;
      position: fixed;
      height: 100vh;
      left: 0;
      top: 0;
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
      z-index: 1000;
      overflow-y: auto;
    }

    .sidebar-header {
      padding: 1.5rem 1rem;
      border-bottom: 1px solid rgba(255,255,255,0.2);
      background: rgba(0,0,0,0.1);
    }

    .sidebar-title {
      font-size: 1.1rem;
      font-weight: bold;
      color: white;
      text-decoration: none;
    }

    .nav-menu {
      padding: 1rem 0;
    }

    .nav-item {
      display: block;
      padding: 0.75rem 1.5rem;
      color: rgba(255,255,255,0.9);
      text-decoration: none;
      transition: all 0.3s ease;
      border-left: 3px solid transparent;
    }

    .nav-item:hover {
      background: rgba(255,255,255,0.1);
      color: white;
      border-left-color: #fff;
    }

    .nav-item.active {
      background: rgba(255,255,255,0.15);
      color: white;
      border-left-color: #fff;
      font-weight: 500;
    }
    h1 { 
      text-align: center; 
      margin-bottom: 2rem; 
      color: #333;
    }

    /* Form styling */
    .form-container {
      background: #f9f9f9;
      padding: 2rem;
      border-radius: 8px;
      border: 1px solid #ddd;
      margin-bottom: 3rem;
    }
    
    .form-group {
      margin-bottom: 1.5rem;
    }
    
    label {
      display: block;
      font-weight: bold;
      margin-bottom: 0.5rem;
      color: #333;
    }
    
    input[type="text"], textarea, select {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1rem;
      box-sizing: border-box;
    }
    
    textarea {
      height: 100px;
      resize: vertical;
    }
    
    select:disabled {
      background-color: #f5f5f5;
      color: #666;
    }
    
    .submit-container {
      text-align: center;
      margin-top: 2rem;
    }
    
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 1rem 2rem;
      font-size: 1rem;
      border-radius: 4px;
      cursor: pointer;
    }
    
    button:hover {
      background: #0056b3;
    }
    
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    /* Status messages */
    .loading, .error, .success { 
      text-align: center; 
      margin: 1rem 0; 
      padding: 1rem;
      border-radius: 4px;
    }
    .loading { 
      background: #e3f2fd; 
      color: #1976d2; 
    }
    .error { 
      background: #ffebee; 
      color: #d32f2f; 
    }
    .success { 
      background: #e8f5e8; 
      color: #2e7d32; 
    }
    
    .hide { display: none; }

    /* Table styling */
    .table-container {
      background: #f9f9f9;
      padding: 2rem;
      border-radius: 8px;
      border: 1px solid #ddd;
    }

    .table-container h2 {
      margin-top: 0;
      margin-bottom: 1.5rem;
      color: #333;
      text-align: center;
    }

    .checks-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 4px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .checks-table th,
    .checks-table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }

    .checks-table th {
      background: #f8f9fa;
      font-weight: bold;
      color: #333;
    }

    .checks-table tr:hover {
      background: #f8f9fa;
    }

    .checks-table tr:last-child td {
      border-bottom: none;
    }

    .monitor-count {
      text-align: center;
      font-weight: bold;
      color: #007bff;
    }

    .no-package {
      font-style: italic;
      color: #666;
    }

    .table-loading {
      text-align: center;
      padding: 2rem;
      color: #666;
    }

    .table-error {
      text-align: center;
      padding: 2rem;
      color: #d32f2f;
      background: #ffebee;
      border-radius: 4px;
    }
  </style>
</head>
<body>    
  <nav class="sidebar">
        <div class="sidebar-header">
          <a href="#" class="sidebar-title">Monitor Alerts Setup</a>
        </div>
        <div class="nav-menu">
          <a href="https://ndustrialinternal.github.io/checkCreator/" class="nav-item active">Step 1 - Create Checks</a>
          <a href="https://ndustrialinternal.github.io/monitorAdd/" class="nav-item">Step 2 - Add Monitors</a>
          <a href="https://ndustrialinternal.github.io/SubscribeUser/" class="nav-item">Step 3 Subscribe Users</a>
          <a href="https://ndustrialinternal.github.io/UnsubscribeUser/" class="nav-item">Step 4 Unsubscribe Users</a>
          <div style="margin-top: auto; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.2);">
  <a href="https://docs.google.com/document/d/10Dqs98g22ToKnryuLeJToUehbigKlNurY8eTORvE2KE/edit?usp=sharing" 
     target="_blank" 
     class="nav-item" 
     style="opacity: 0.8; font-size: 0.9rem;">
    Documentation
  </a>
</div>
        </div>
  </nav>
  <h1>Check Creator</h1>

  <div class="form-container">
    <!-- Organization selector -->
    <div class="form-group">
      <label for="org-select">Organization</label>
      <select id="org-select">
        <option value="">Select Organization</option>
      </select>
    </div>

    <!-- Check form fields -->
    <div class="form-group">
      <label for="name-input">Name *</label>
      <input type="text" id="name-input" placeholder="Enter check name" required />
    </div>

    <div class="form-group">
      <label for="description-input">Description</label>
      <textarea id="description-input" placeholder="Enter check description"></textarea>
    </div>

    <div class="form-group">
      <label for="package-select">Software Package</label>
      <select id="package-select" disabled>
        <option value="">Select Organization First</option>
      </select>
    </div>

    <!-- Status messages -->
    <div id="loading" class="loading hide">Loading...</div>
    <div id="error" class="error hide"></div>
    <div id="success" class="success hide"></div>

    <!-- Submit button -->
    <div class="submit-container">
      <button id="submit-btn" disabled>Create Check</button>
    </div>
  </div>

  <!-- Existing Checks Table -->
  <div class="table-container">
    <h2>Existing Checks</h2>
    <div id="table-content">
      <div class="table-loading">Select an organization to view existing checks</div>
    </div>
  </div>

  <script>
  (function(){
    // Organization to proxy endpoint mapping
    const ORG_URLS = {
      "Lineage":   "https://cp-alert-signoff-proxy.onrender.com/lineage",
      "Demo":      "https://cp-alert-signoff-proxy.onrender.com/demo",
      "Emergent":  "https://cp-alert-signoff-proxy.onrender.com/emergent",
      "Americold": "https://cp-alert-signoff-proxy.onrender.com/americold",
      "US Cold":   "https://cp-alert-signoff-proxy.onrender.com/uscold",
      "Envision":  "https://cp-alert-signoff-proxy.onrender.com/envision",
      "WL Gore":   "https://cp-alert-signoff-proxy.onrender.com/wlgore"
    };

    // DOM references
    const orgSelect = document.getElementById('org-select');
    const nameInput = document.getElementById('name-input');
    const descriptionInput = document.getElementById('description-input');
    const packageSelect = document.getElementById('package-select');
    const submitBtn = document.getElementById('submit-btn');
    const loadingEl = document.getElementById('loading');
    const errorEl = document.getElementById('error');
    const successEl = document.getElementById('success');
    const tableContent = document.getElementById('table-content');

    let softwarePackages = [];
    let selectedOrgUrl = '';
    let existingChecks = [];

    // Populate organization dropdown
    Object.keys(ORG_URLS).forEach(function(org){
      orgSelect.appendChild(new Option(org, org));
    });

    // Event listeners
    orgSelect.addEventListener('change', onOrgChange);
    nameInput.addEventListener('input', validateForm);
    submitBtn.addEventListener('click', createCheck);

    // When organization changes, load software packages and existing checks
    async function onOrgChange() {
      const selectedOrg = orgSelect.value;
      selectedOrgUrl = ORG_URLS[selectedOrg];
      
      // Reset package dropdown
      packageSelect.innerHTML = '<option value="">Loading...</option>';
      packageSelect.disabled = true;
      submitBtn.disabled = true;
      hideMessages();

      if (!selectedOrg) {
        packageSelect.innerHTML = '<option value="">Select Organization First</option>';
        tableContent.innerHTML = '<div class="table-loading">Select an organization to view existing checks</div>';
        return;
      }

      showLoading();
      tableContent.innerHTML = '<div class="table-loading">Loading existing checks...</div>';

      try {
        // Load both software packages and existing checks
        await Promise.all([
          loadSoftwarePackages(selectedOrg),
          loadExistingChecks(selectedOrg)
        ]);
        
        populatePackageDropdown();
        renderChecksTable();
        hideLoading();
        showSuccess('Data loaded successfully!');
        setTimeout(() => { hideMessages(); }, 3000);
        validateForm();

      } catch (error) {
        hideLoading();
        showError('Failed to load data: ' + error.message);
        packageSelect.innerHTML = '<option value="">Error loading packages</option>';
        tableContent.innerHTML = '<div class="table-error">Error loading checks: ' + error.message + '</div>';
      }
    }

    // Load software packages for the selected organization
    async function loadSoftwarePackages(org) {
      const url = ORG_URLS[org];
      const query = `
        query($filter: SoftwarePackageFilter) {
          softwarePackages(filter: $filter) {
            nodes {
              id
              name
              slug
            }
          }
        }`;
      
      const variables = {
        filter: {
          isEnabled: { equalTo: true }
        }
      };

      const response = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ query, variables })
      });

      if (!response.ok) {
        throw new Error('Failed to fetch software packages: ' + response.status);
      }

      const data = await response.json();
      if (data.errors) {
        throw new Error('GraphQL errors: ' + data.errors.map(e => e.message).join(', '));
      }

      softwarePackages = data.data.softwarePackages.nodes || [];
    }

    // Load existing checks for the selected organization
    async function loadExistingChecks(org) {
      const url = ORG_URLS[org];
      const query = `
        query {
          checks {
            nodes {
              name
              checkMonitors {
                totalCount
              }
              softwarePackage {
                name
              }
            }
          }
        }`;

      const response = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ query })
      });

      if (!response.ok) {
        throw new Error('Failed to fetch existing checks: ' + response.status);
      }

      const data = await response.json();
      if (data.errors) {
        throw new Error('GraphQL errors: ' + data.errors.map(e => e.message).join(', '));
      }

      existingChecks = data.data.checks.nodes || [];
    }

    // Populate the package dropdown
    function populatePackageDropdown() {
      packageSelect.innerHTML = '<option value="">None (no software package)</option>';
      
      softwarePackages
        .sort((a, b) => a.name.localeCompare(b.name))
        .forEach(pkg => {
          packageSelect.appendChild(new Option(pkg.name, pkg.id));
        });

      packageSelect.disabled = false;
    }

    // Render the existing checks table
    function renderChecksTable() {
      if (existingChecks.length === 0) {
        tableContent.innerHTML = '<div class="table-loading">No existing checks found for this organization</div>';
        return;
      }

      // Sort checks alphabetically by name
      const sortedChecks = existingChecks.sort((a, b) => a.name.localeCompare(b.name));

      const tableHtml = `
        <table class="checks-table">
          <thead>
            <tr>
              <th>Check Name</th>
              <th>Number of Monitors</th>
              <th>Software Package</th>
            </tr>
          </thead>
          <tbody>
            ${sortedChecks.map(check => `
              <tr>
                <td>${escapeHtml(check.name)}</td>
                <td class="monitor-count">${check.checkMonitors.totalCount}</td>
                <td>${check.softwarePackage ? escapeHtml(check.softwarePackage.name) : '<span class="no-package">No package</span>'}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;

      tableContent.innerHTML = tableHtml;
    }

    // Validate form and enable/disable submit button
    function validateForm() {
      const isValid = orgSelect.value && nameInput.value.trim();
      submitBtn.disabled = !isValid;
    }

    // Create the check using the mutation
    async function createCheck() {
      const name = nameInput.value.trim();
      const description = descriptionInput.value.trim();
      const selectedPackageId = packageSelect.value || null;

      if (!name) {
        showError('Please enter a check name');
        return;
      }

      hideMessages();
      showLoading();
      submitBtn.disabled = true;

      try {
        // Generate slug from name (camelCase)
        const slug = name
          .replace(/[^a-zA-Z0-9\s]/g, '') // Remove special characters
          .split(' ')
          .map((word, index) => {
            if (index === 0) return word.toLowerCase();
            return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
          })
          .join('');

        const mutation = `
          mutation($input: CreateCheckInput!) {
            createCheck(input: $input) {
              clientMutationId
            }
          }`;

        const variables = {
          input: {
            check: {
              closureMessageRequired: false,
              description: description || '',
              incidentsEnabled: false,
              isEnabled: true,
              name: name,
              reminderIntervalSeconds: 172800,
              severityId: 6,
              slug: slug,
              softwarePackageId: selectedPackageId ? parseInt(selectedPackageId) : null
            }
          }
        };

        const response = await fetch(selectedOrgUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query: mutation, variables })
        });

        if (!response.ok) {
          throw new Error('Failed to create check: ' + response.status);
        }

        const data = await response.json();
        if (data.errors) {
          throw new Error('GraphQL errors: ' + data.errors.map(e => e.message).join(', '));
        }

        hideLoading();
        showSuccess('Check created successfully!');
        
        // Reset form
        nameInput.value = '';
        descriptionInput.value = '';
        packageSelect.value = '';
        validateForm();

        // Reload existing checks to show the new one
        await loadExistingChecks(orgSelect.value);
        renderChecksTable();

      } catch (error) {
        hideLoading();
        showError('Failed to create check: ' + error.message);
        submitBtn.disabled = false;
      }
    }

    // Utility functions for UI state management
    function showLoading() {
      loadingEl.classList.remove('hide');
    }

    function hideLoading() {
      loadingEl.classList.add('hide');
    }

    function showError(message) {
      errorEl.textContent = message;
      errorEl.classList.remove('hide');
    }

    function showSuccess(message) {
      successEl.textContent = message;
      successEl.classList.add('hide');
    }

    function hideMessages() {
      loadingEl.classList.add('hide');
      errorEl.classList.add('hide');
      successEl.classList.add('hide');
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

  })();
  </script>
</body>
</html>
